# 😸🐶 반려동물 통합관리 시스템 및 제어 앱

<div align="right">
  마이크로프로세서및실험
  Date: 2022.04.23 - 2022.06.12
</div>
<br>

<img src="https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F4d1e6463-0ddd-4322-9885-3b3501c1e9ea%2F%25EC%25BB%25A4%25EB%25B2%2584.jpg?table=block&id=9c38281b-d776-4419-93a3-cb2e8670093a&spaceId=bbd4c5bb-0d54-4459-b0d9-4bdcefc6f6e3&width=1920&userId=531bb916-de27-453d-8381-82bd4a86f01a&cache=v2">
<br>

## 메인 아이디어
- 집에 혼자 있는 반려동물을 어떻게 관리할 수 있을까 ❓
- 사료 급여, 영상 시청, 온습도 확인, 녹음 기능을 통합하여 제어하자 💡
- 라즈베리파이와 여러 센서를 사용해 자동 급식기와 안드로이드 앱 제작 📲
<br>

## 사용자 인터페이스
<!--메인화면-->
<h3 align="center">
  여러 기능을 통합하여 간편하게 사용할 수 있어요! 👍 
</h3>
<div align="center">
  <img src="https://brave-horse-48d.notion.site/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fe71b3849-27b1-423d-b6f0-e80371d0f8e8%2Fimage11.png?table=block&id=ccc5b218-db74-4371-9e34-b93c0942b02f&spaceId=bbd4c5bb-0d54-4459-b0d9-4bdcefc6f6e3&width=380&userId=&cache=v2" width="249" height="443"/>
</div>
<hr>
    
<!--온습도-->
<h3 align="center">
  온습도를 실시간으로 확인해봐요! 🌡💧
</h3>
<div align="center">

  **주변 환경을 확인할 수 있어요 🤍** <br><br>
  <img src="https://github.com/irrso/microprocessor-integrated-pet-management-system/assets/105829324/f629a18f-aebc-47ea-8fa4-d360ad3de940" width="50%" height="auto"/>
</div>
<hr>

<!--사료급여-->
<h3 align="center">
  시간을 조절하여 사료를 급여해봐요! 🍴
</h3>
<div align="center">
  
   **원하는 양의 사료를 급여할 수 있어요 🤍** <br><br>
  <img src="https://github.com/irrso/Mobile_project/assets/105829324/24ecada9-7af6-4ed1-8287-3262d7db50d8" width="249" height="443"/>
  <br><br>
  바를 움직여서 원하는 사료 양을 조절해요.
</div>
<hr>

<!--영상시청-->
<h3 align="center">
  지금 당장 반려동물의 영상을 시청해봐요! 👀
</h3>
<div align="center">
  
  **지금 무엇을 하고있는지 확인할 수 있어요 🤍** <br><br>
  <img src="https://github.com/irrso/Mobile_project/assets/105829324/12cf01d6-878a-42c6-b38b-3c86b6df4822" width="249" height="443"/>
</div>
<hr>

<!--녹음기능-->
<h3 align="center">
  반려동물에게 여러분의 목소리를 들려주세요! 🔊
</h3>
<div align="center">
  
  **마이크를 눌러 녹음하고 내용을 확인 후 전송할 수 있어요 🤍** <br><br>
  <img src="https://github.com/irrso/Mobile_project/assets/105829324/3fca2055-9cb1-4abb-aea3-3e58a171ffbb" width="249" height="443"/>
  <br><br>
  마이크를 눌러 녹음을 시작하고 다시 눌러 녹음을 종료해요.<br><br>
  재생 및 정지 버튼을 통해 녹음 내용을 확인해요.<br><br>
  전송 버튼을 눌러 반려동물에게 목소리를 공유해봐요.
</div>
<br>

## 역할 분담
<!--표 추가-->
|팀장|팀원|팀원|
|:---:|:---:|:---:|
|[오소영](https://github.com/irrso)|***|***|
|앱 설계 및 제작 <br> 데이터베이스 연동 <br> 발표 자료 제작 및 제출 <br> 필요 물품 리스트업 및 수령 <br> 코드 형상관리|앱 제작 <br> firebase 데이터 전송 관리 및 구현 <br> 프로젝트 제안 및 최종 발표|자동 급식기 제작 및 센서 부착 <br> 라즈베리파이 센서 회로 설계 및 코드 구현|
<br>

## 기술 스택
|분류|기술 스택|
|---|---|
|S/W|<img src="https://img.shields.io/badge/Android-34A853.svg?style=flat-square&logo=android&logoColor=white"/> <img src="https://img.shields.io/badge/Android Studio-3DDC84.svg?style=flat-square&logo=androidstudio&logoColor=white"/> <img src="https://img.shields.io/badge/Java(JDK1.8)-007396.svg?style=flat-square&logo=java&logoColor=white"/>|
|H/W|<img src="https://img.shields.io/badge/Raspbian GNU/Linux 11-A22846.svg?style=flat-square&logo=raspberrypi&logoColor=white"/> <img src="https://img.shields.io/badge/Firebase-FFCA28.svg?style=flat-square&logo=firebase&logoColor=white"/> <img src="https://img.shields.io/badge/C-A8B9CC.svg?style=flat-square&logo=c&logoColor=black"/> <img src="https://img.shields.io/badge/Python-3776AB.svg?style=flat-square&logo=python&logoColor=white"/>|
|협업|<img src="https://img.shields.io/badge/KakaoTalk-FFCD00.svg?style=flat-square&logo=kakaotalk&logoColor=black"/> <img src="https://img.shields.io/badge/Google Docs-4285F4.svg?style=flat-square&logo=googledocs&logoColor=white"/> <img src="https://img.shields.io/badge/GitHub-181717.svg?style=flat-square&logo=github&logoColor=white"/>|

### 라즈베리파이
- `pi카메라`를 이용하여 영상 송출
- `서보모터`를 이용하여 사료 급여
- `스피커`를 이용하여 음성 재생
- `온습도센서`를 이용하여 온습도 표시

### firebase
- `feed`키를 통해 사료 관련 데이터 송수신
- `voice`키와 `recorded.wav`파일을 통해 음성 데이터 송수신
- `humidity`, `temperature`키를 통해 온습도 관련 데이터 송수신
<br>

## 시스템 개요
- 라즈베리파이: 자동 급식기에 부착된 센서 제어, pi카메라를 위한 웹 호스팅 역할
- 스마트폰: 앱을 통해 라즈베리파이에 데이터 전송 및 수신, 자동 급식기 논리적으로 제어하는 UI 역할
- firebase: 라즈베리파이와 스마트폰 앱 간의 전송 매개체 역할, 로컬에 국한되지 않은 제어 구현 [^id]
[^id]: 🚩 pi카메라를 통한 안심 카메라 기능은 도메인 설정 및 포워딩 등의 문제가 발생해 로컬로만 실행하도록 구상

|시스템 구상도|시스템 회로도|
|:---:|:---:|
|<img src="https://github.com/irrso/Mobile_project/assets/105829324/0198ef37-d9bd-457a-96d5-cbd92e2d47d5" width="110%" height="auto">|<img src="https://github.com/irrso/Mobile_project/assets/105829324/cac1aed3-de5f-4209-a72e-b3a6f99b7b2e" width="90%" height="auto">|
<br>

## 시스템 기능
### 자동 급식기
- 모터를 통해 자동으로 사료를 공급하는 하드웨어
<img src="https://github.com/irrso/MP_project_sy/assets/105829324/94c60ecd-5b54-47c2-a816-765e1017b092" width="25%" height="auto"/>

<details>
    <summary> <img src="https://img.shields.io/badge/MainActivity.Java-007396.svg?style=flat-square"/> </summary>

  ```Java
        //feed 초기값
        dbReference = FirebaseDatabase.getInstance().getReference();
        dbReference.child("feed").setValue(0);

        //사료주기
        seekBar.setOnSeekBarChangeListener(new SeekBar.OnSeekBarChangeListener() {
            @Override
            public void onProgressChanged(SeekBar seekBar, int i, boolean b) {
                progress = i * 0.5;
                se.setText(progress + "초");
            }

            @Override
            public void onStartTrackingTouch(SeekBar seekBar) {

            }

            @Override
            public void onStopTrackingTouch(SeekBar seekBar) {

            }
        });

        feedBtn.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                dbReference.child("feed").setValue(progress);
                Handler mHandler = new Handler();
                Toast.makeText(getApplicationContext(), "사료주기 완료", Toast.LENGTH_SHORT).show();
            }
        });
  ```
</details>

<details>
    <summary> <img src="https://img.shields.io/badge/servo_firebase.py-3776AB.svg?style=flat-square"/> </summary>

  ```Python
import RPi.GPIO as GPIO
import time;

# firebase
import firebase_admin
from firebase_admin import credentials
from firebase_admin import db

#firebase auth and init
cred = credentials.Certificate('firebaseKey.json')
firebase_admin.initialize_app(cred,{
    'databaseURL' : 'https://mptest-48b84-default-rtdb.firebaseio.com/'
    })

dir = db.reference()
GPIO.setmode(GPIO.BCM)
GPIO.setup(2,GPIO.OUT)
a = GPIO.PWM(2,50)
            
while True:
    feedtime = dir.child('feed').get()
    print("feed : "+str(feedtime))
    if feedtime != 0:
        dir.update({'feed' : 0})
        GPIO.output(2, True)
        a.start(0)
        a.ChangeDutyCycle(1.2)
        time.sleep(feedtime)
        a.ChangeDutyCycle(6.8)
        GPIO.output(2, False)
        time.sleep(1)
    else:
        a.start(0)
        time.sleep(1)
    
GPIO.cleanup()
  ```
</details>

### 안심 카메라
- 혼자 있는 반려동물을 촬영하는 카메라
<img src="https://github.com/irrso/MP_project_sy/assets/105829324/55318799-9057-4cb4-aa7d-0526db9f2f9d" width="25%" height="auto"/>

<details>
    <summary> <img src="https://img.shields.io/badge/MainActivity.Java-007396.svg?style=flat-square"/> </summary>

  ```Java
         //영상보기
        videoBtn.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                Intent intent = new Intent(getApplicationContext(), VideoActivity.class);
                startActivity(intent);
            }
        });
  ```
</details>

<details>
    <summary> <img src="https://img.shields.io/badge/play.py-3776AB.svg?style=flat-square"/> </summary>

  ```Python
import io
import picamera
import logging
import socketserver
import RPi.GPIO as GPIO
import time

from threading import Condition
from http import server

PAGE="""\
<html>
<head>
</head>
<body>
<img src="stream.mjpg" width="640" height="480" />
</body>
</html>
"""
def play():
    GPIO.setmode(GPIO.BCM)
    gpio_pin = 12
    scale = [261, 294, 329, 349, 392, 440, 493, 523]
    GPIO.setup(gpio_pin, GPIO.OUT)
    list = [1,2,3,4,5,6,7,8]

    try:
        p = GPIO.PWM(gpio_pin, 100)
        p.start(100)
        p.ChangeDutyCycle(90)
    
        for i in range(9):
            p.ChangeFrequency(scale[list[i]])
            if i == 6:
                time.sleep(1)
            else:
                time.sleep(0.5)       
        p.stop()
    finally:
        GPIO.cleanup()



#play()

class StreamingOutput(object):
    def __init__(self):
        self.frame = None
        self.buffer = io.BytesIO()
        self.condition = Condition()

    def write(self, buf):
        if buf.startswith(b'\xff\xd8'):
            # New frame, copy the existing buffer's content and notify all
            # clients it's available
            self.buffer.truncate()
            with self.condition:
                self.frame = self.buffer.getvalue()
                self.condition.notify_all()
            self.buffer.seek(0)
        return self.buffer.write(buf)

class StreamingHandler(server.BaseHTTPRequestHandler):
    def do_GET(self):
        if self.path == '/':
            self.send_response(301)
            self.send_header('Location', '/index.html')
            self.end_headers()
        elif self.path == '/index.html':
            content = PAGE.encode('utf-8')
            self.send_response(200)
            self.send_header('Content-Type', 'text/html')
            self.send_header('Content-Length', len(content))
            self.end_headers()
            self.wfile.write(content)
        elif self.path == '/stream.mjpg':
            self.send_response(200)
            self.send_header('Age', 0)
            self.send_header('Cache-Control', 'no-cache, private')
            self.send_header('Pragma', 'no-cache')
            self.send_header('Content-Type', 'multipart/x-mixed-replace; boundary=FRAME')
            self.end_headers()
            try:
                while True:
                    with output.condition:
                        output.condition.wait()
                        frame = output.frame
                    self.wfile.write(b'--FRAME\r\n')
                    self.send_header('Content-Type', 'image/jpeg')
                    self.send_header('Content-Length', len(frame))
                    self.end_headers()
                    self.wfile.write(frame)
                    self.wfile.write(b'\r\n')
            except Exception as e:
                logging.warning(
                    'Removed streaming client %s: %s',
                    self.client_address, str(e))
        else:
            self.send_error(404)
            self.end_headers()

class StreamingServer(socketserver.ThreadingMixIn, server.HTTPServer):
    allow_reuse_address = True
    daemon_threads = True

with picamera.PiCamera(resolution='640x480', framerate=24) as camera:
    output = StreamingOutput()
    camera.start_recording(output, format='mjpeg')
    try:
        address = ('', 8000)
        server = StreamingServer(address, StreamingHandler)
        server.serve_forever()
    finally:
        camera.stop_recording()
  ```
</details>

### 안심 스피커
- 앱을 통해 전달된 음성 녹음을 반려동물에게 들려주는 스피커
<img src="https://github.com/irrso/MP_project_sy/assets/105829324/3201ea8a-a5ff-4ebf-9207-bcb3f5e703bd" width="25%" height="auto"/>

<details>
    <summary> <img src="https://img.shields.io/badge/MainActivity.Java-007396.svg?style=flat-square"/> </summary>

  ```Java
        //녹음하기
        voiceBtn.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                Intent intent = new Intent(getApplicationContext(), VoiceActivity.class);
                startActivity(intent);
            }
        });
  ```
</details>

<details>
    <summary> <img src="https://img.shields.io/badge/voice.py-3776AB.svg?style=flat-square"/> </summary>

  ```Python
import pyrebase
import vlc
import time

import firebase_admin
from firebase_admin import credentials
from firebase_admin import db

config = {
    "apiKey": "AIzaSyB7Rzk4o11hX1tkJJYleUoQPsIVcCPWoJw",
    "authDomain": "mptest-48b84.firebaseapp.com",
    "databaseURL": "https://mptest-48b84-default-rtdb.firebaseio.com",
    "projectId": "mptest-48b84",
    "storageBucket": "mptest-48b84.appspot.com",
    "messagingSenderId": "229031734122",
    "appId": "1:229031734122:web:7f43734df59079c0e45313"
    }

cred = credentials.Certificate('firebaseKey.json')
firebase_admin.initialize_app(cred,{
    'databaseURL' : 'https://mptest-48b84-default-rtdb.firebaseio.com/'
    })

dir = db.reference()

while True:
    voiceflag = dir.child('voice').get()
    print("voice : "+ str(voiceflag))
    
    if voiceflag:
        dir.update({'voice':False})
        time.sleep(4)
        firebase = pyrebase.initialize_app(config)
        storage = firebase.storage()
        storage.child("voice/recorded.wav").download("recorded_d.wav")
        time.sleep(4)
        p = vlc.MediaPlayer("recorded_d.wav")
        p.play()
    else:
        time.sleep(1)
  ```
</details>

### 안심 온습도
- 반려동물의 환경이 쾌적한 온습도인지 확인하는 시스템
<img src="https://github.com/irrso/MP_project_sy/assets/105829324/c79d1d29-6b12-4f73-8666-e91173a327c0" width="25%" height="auto"/>

<details>
    <summary> <img src="https://img.shields.io/badge/MainActivity.Java-007396.svg?style=flat-square"/> </summary>

  ```Java
        //온습도
        database = FirebaseDatabase.getInstance();
        myRef = database.getReference("temphumi");

        myRef.addValueEventListener(new ValueEventListener() {
            @Override
            public void onDataChange(@NonNull DataSnapshot snapshot) {
                Double value1 = snapshot.child("temperature").getValue(Double.class);
                Double value2 = snapshot.child("humidity").getValue(Double.class);
                te.setText(value1+"°C"); //"\'C"
                hu.setText(value2+"%");
            }

            @Override
            public void onCancelled(@NonNull DatabaseError error) {
            }
        });
  ```
</details>

<details>
    <summary> <img src="https://img.shields.io/badge/temper_humi.py-3776AB.svg?style=flat-square"/> </summary>

  ```Python
import RPi.GPIO as GPIO
import time;
import Adafruit_DHT

# firebase
import firebase_admin
from firebase_admin import credentials
from firebase_admin import db

#firebase auth and init
cred = credentials.Certificate('firebaseKey.json')
firebase_admin.initialize_app(cred,{
    'databaseURL' : 'https://mptest-48b84-default-rtdb.firebaseio.com/'
    })

sensor = Adafruit_DHT.DHT11

while(True):
    humidity, temperature = Adafruit_DHT.read_retry(sensor, 17)
    if humidity is not None and temperature is not None:
        print('Temp {0:0.1f}*c Humidty = {1:0.1f}%'.format(temperature ,humidity))
        temp = temperature
        humi = humidity
        dir = db.reference('temphumi')
        dir.update({'temperature':temp})
        dir.update({'humidity':humi})
    
    
    else:
        print('fail')

    time.sleep(3)

GPIO.cleanup()
  ```
</details>
